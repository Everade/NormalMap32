{
	"name": "Event sheet 1",
	"events": [
		{
			"eventType": "comment",
			"text": "Light Curve algorithm is based on Falloff values:\nY = clamp( 1 - A + B*X*X + C*X*X*X*X*X ) ,0 ,1 )\n                                                                                               (A)______(B)\nX axis = light distance to pixel                                                               \\\nY axis = light strength                                                           Y^             \\ (C)\n                                                                                                   X>\n\n--------------------------------------------------------------------------------\nLight Strength Falloff A [015]\n>= 1 is OFF\n      0 is ON\n  < 0 increases the 100% strength radius from inner to out, also results in a harder falloff for B and C.\n--------------------------------------------------------------------------------\nLight Soft Falloff B [016]\n<= 0 no Falloff\n--------------------------------------------------------------------------------\nLight Hard Falloff C [017]  -  Shall never go below 0\n--------------------------------------------------------------------------------"
		},
		{
			"eventType": "comment",
			"text": "-Notice-\nLight settings are set per NormalMap sprite, not on the light source itself.\nThe window resolution must also be set on all the NormalMaps, for proper light positioning. (We set resolution values automatically in this example)\n\nFor \"type\" i'm refering to the number labels on each light bulp, which represent \"Light 1-32\" within the effect parameters."
		},
		{
			"eventType": "variable",
			"name": "VPR",
			"type": "number",
			"initialValue": "0",
			"comment": "Viewport Right (X coordinate)",
			"isStatic": true,
			"isConstant": false,
			"sid": 481407124972419
		},
		{
			"eventType": "variable",
			"name": "VPB",
			"type": "number",
			"initialValue": "0",
			"comment": "Viewport Bottom (Y coordinate)",
			"isStatic": true,
			"isConstant": false,
			"sid": 287276473001883
		},
		{
			"eventType": "variable",
			"name": "PR",
			"type": "number",
			"initialValue": "0",
			"comment": "Device Pixel Ratio",
			"isStatic": true,
			"isConstant": false,
			"sid": 368860786706967
		},
		{
			"eventType": "variable",
			"name": "WH",
			"type": "number",
			"initialValue": "0",
			"comment": "Height of canvas absolute size (including pixel ratio)",
			"isStatic": true,
			"isConstant": false,
			"sid": 773059037547027
		},
		{
			"eventType": "variable",
			"name": "WW",
			"type": "number",
			"initialValue": "0",
			"comment": "Width of canvas absolute size (including pixel ratio)",
			"isStatic": true,
			"isConstant": false,
			"sid": 122669093239176
		},
		{
			"eventType": "variable",
			"name": "WWL",
			"type": "number",
			"initialValue": "0",
			"comment": "Width of canvas - Light",
			"isStatic": true,
			"isConstant": false,
			"sid": 260268730614673
		},
		{
			"eventType": "variable",
			"name": "WHL",
			"type": "number",
			"initialValue": "0",
			"comment": "Height of canvas - Light",
			"isStatic": true,
			"isConstant": false,
			"sid": 109353941550532
		},
		{
			"eventType": "variable",
			"name": "normalOffset",
			"type": "number",
			"initialValue": "16",
			"comment": "NormalMap32 - Parameter offset for next light",
			"isStatic": true,
			"isConstant": true,
			"sid": 618795988924036
		},
		{
			"eventType": "variable",
			"name": "maxLightType",
			"type": "number",
			"initialValue": "31",
			"comment": "Max light type used for current world (decrease for max performance)",
			"isStatic": true,
			"isConstant": false,
			"sid": 237218561971702
		},
		{
			"eventType": "comment",
			"text": "Initialize viewport effect parameters for the normal map."
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-start-of-layout",
					"objectClass": "System",
					"sid": 968108995278572
				}
			],
			"actions": [
				{
					"id": "wait",
					"objectClass": "System",
					"sid": 133444299575313,
					"parameters": {
						"seconds": "0"
					}
				},
				{
					"callFunction": "UpdateViewport",
					"sid": 440557808064536
				}
			],
			"sid": 505840886885261
		},
		{
			"eventType": "comment",
			"text": "Initialize viewport effect parameters upon normal map creation."
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-created",
					"objectClass": "fNormal",
					"sid": 618023994554685
				}
			],
			"actions": [
				{
					"callFunction": "UpdateNormalViewport",
					"sid": 684932867829355,
					"parameters": [
						"fNormal.UID"
					]
				}
			],
			"sid": 251446154350195
		},
		{
			"eventType": "comment",
			"text": "Update viewport on the normal map effect parameters when viewport is being resized."
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-resized",
					"objectClass": "Browser",
					"sid": 711593988466275
				}
			],
			"actions": [
				{
					"callFunction": "UpdateViewport",
					"sid": 170921504486773
				}
			],
			"sid": 205192574689990
		},
		{
			"eventType": "comment",
			"text": "Update light source positions on the normal map effect parameters every tick."
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "every-tick",
					"objectClass": "System",
					"sid": 734128620297281
				},
				{
					"id": "is-on-screen",
					"objectClass": "fNormal",
					"sid": 323528866459548
				},
				{
					"id": "for-each",
					"objectClass": "System",
					"sid": 277009629918859,
					"parameters": {
						"object": "fNormal"
					}
				},
				{
					"id": "for",
					"objectClass": "System",
					"sid": 617137740340318,
					"parameters": {
						"name": "\"bulptype\"",
						"start-index": "1",
						"end-index": "maxLightType"
					}
				},
				{
					"id": "compare-animation-frame",
					"objectClass": "LightSource",
					"sid": 713322861693096,
					"parameters": {
						"comparison": 0,
						"number": "loopindex"
					}
				},
				{
					"id": "is-boolean-instance-variable-set",
					"objectClass": "LightSource",
					"sid": 711031174318285,
					"parameters": {
						"instance-variable": "on"
					}
				},
				{
					"id": "pick-nearestfurthest",
					"objectClass": "LightSource",
					"sid": 611052294649941,
					"parameters": {
						"which": "nearest",
						"x": "fNormal.X",
						"y": "fNormal.Y"
					}
				}
			],
			"actions": [
				{
					"type": "comment",
					"text": "We loop through all light types on the current map, ambient light excluded. (#01 to #31)\nLess light source types used = better performance."
				},
				{
					"type": "comment",
					"text": "Only one light source of the same type can interrogate with each normal map at a time.\nSo there should never be multiple bulps of the same type in close range to each other.\nWe then always take the closest bulp of each type to be considered as current active light, which allows us to place multiple instances of the same type within the game world.\n\nThis allows us to use an infinite amount of lights per layout, as we switch between them dynamically. Just space them far enough apart.\n\nUse as few light types as possible for maximum performance. Using all 32 will be very CPU heavy.\nFor example: world designed with only bulp type 1-3 (each 10 times) will be more performant than using type 1-6 (just one each), even if they're all out of view.\nBecause the add-on continuesly runs a full loop per type, every few frames or every tick in this example, depending on your setup."
				}
			],
			"sid": 814717327111711,
			"children": [
				{
					"eventType": "comment",
					"text": "Update light position according to current viewport position in relation to the light"
				},
				{
					"eventType": "block",
					"conditions": [],
					"actions": [
						{
							"type": "comment",
							"text": "Light X Position [003]-[XXX]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 475199836725679,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "3-normalOffset+loopindex*normalOffset",
								"value": "(LayerToCanvasX(1, LightSource.X, 0))/(WWL)"
							}
						},
						{
							"type": "comment",
							"text": "Light Y Position [004]-[XXX]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 601859558043169,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "4-normalOffset+loopindex *normalOffset",
								"value": "(LayerToCanvasY(1, 0, LightSource.Y - LightSource.z))/(WHL)"
							}
						}
					],
					"sid": 808371598677097
				},
				{
					"eventType": "comment",
					"text": "Update global ambience position according to current viewport position in relation to the light\nWe use light type 32 for global ambience in this example."
				},
				{
					"eventType": "block",
					"conditions": [],
					"actions": [
						{
							"type": "comment",
							"text": "Light X Position [499]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 389662615704364,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "499",
								"value": "(LayerToCanvasX(1, VPR-ViewportLeft(1), 0))/(WWL)"
							}
						},
						{
							"type": "comment",
							"text": "Light Y Position [500]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 590098881740780,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "500",
								"value": "(LayerToCanvasY(1, 0, VPB-ViewportTop(1)))/(WHL)"
							}
						}
					],
					"sid": 566695850346869
				}
			]
		},
		{
			"eventType": "comment",
			"text": "Viewport Functions"
		},
		{
			"functionName": "UpdateViewport",
			"functionDescription": "Updates all Viewport related variables and updates all Normal Map Screen Resolution effect parameters accordingly.",
			"functionCategory": "Viewport",
			"functionReturnType": "none",
			"functionCopyPicked": false,
			"functionIsAsync": false,
			"functionParameters": [],
			"eventType": "function-block",
			"conditions": [],
			"actions": [],
			"sid": 840447208380024,
			"children": [
				{
					"eventType": "comment",
					"text": "Needed when viewport size or device pixelratio is changed, to render normal map lights positioned properly."
				},
				{
					"eventType": "block",
					"conditions": [],
					"actions": [
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 860590221900321,
							"parameters": {
								"variable": "PR",
								"value": "PlatformInfo.DevicePixelRatio\n"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 993147776039507,
							"parameters": {
								"variable": "VPB",
								"value": "ViewportBottom(1)"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 203526733729274,
							"parameters": {
								"variable": "VPR",
								"value": "ViewportRight(1)\n"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 505289495256606,
							"parameters": {
								"variable": "WWL",
								"value": "round(LayerToCanvasX(1,VPR,0))"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 290498144914092,
							"parameters": {
								"variable": "WHL",
								"value": "round(LayerToCanvasY(1,0,VPB))"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 547916882315523,
							"parameters": {
								"variable": "WW",
								"value": "round(LayerToCanvasX(1,VPR,0)*PR)"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 838155873041424,
							"parameters": {
								"variable": "WH",
								"value": "round(LayerToCanvasY(1,0,VPB)*PR)\n"
							}
						},
						{
							"callFunction": "UpdateNormalViewport",
							"sid": 956173220261987,
							"parameters": [
								"-1"
							]
						}
					],
					"sid": 709891875238117
				}
			]
		},
		{
			"functionName": "UpdateNormalViewport",
			"functionDescription": "Updates a Normal Maps' Screen X and Y Resolution effect parameters.",
			"functionCategory": "Viewport",
			"functionReturnType": "none",
			"functionCopyPicked": false,
			"functionIsAsync": false,
			"functionParameters": [
				{
					"name": "UIDnormal",
					"type": "number",
					"initialValue": "-1",
					"comment": "Normal Map UID, use (-1) to update all.",
					"sid": 241917405968939
				}
			],
			"eventType": "function-block",
			"conditions": [],
			"actions": [],
			"sid": 179327019392846,
			"children": [
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "compare-two-values",
							"objectClass": "System",
							"sid": 222873670692789,
							"parameters": {
								"first-value": "UIDnormal",
								"comparison": 1,
								"second-value": "-1"
							}
						},
						{
							"id": "pick-by-unique-id",
							"objectClass": "fNormal",
							"sid": 379190405132211,
							"parameters": {
								"unique-id": "UIDnormal"
							}
						}
					],
					"actions": [
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 671672679282056,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "0",
								"value": "WW"
							}
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 238526560571725,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "1",
								"value": "WH"
							}
						}
					],
					"sid": 411010232517125
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "else",
							"objectClass": "System",
							"sid": 233540283737280
						}
					],
					"actions": [
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 257698691879102,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "0",
								"value": "WW"
							}
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 602212517966692,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "1",
								"value": "WH"
							}
						}
					],
					"sid": 302860329065571
				}
			]
		}
	],
	"sid": 562980631431129
}