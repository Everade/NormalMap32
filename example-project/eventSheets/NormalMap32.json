{
	"name": "NormalMap32",
	"events": [
		{
			"eventType": "comment",
			"text": "-Notice-\nLight settings are set per Normal Map sprite, not on the light source itself.\nThe window resolution must also be set on all the NormalMaps, for proper light positioning. (We set resolution values automatically in this example)\n\nFor \"Light ID\" i'm referring to the number labels of the effect parameters."
		},
		{
			"eventType": "comment",
			"text": "Light Curve algorithm is based on Falloff values:\nY = clamp( 1 - A + B*X*X + C*X*X*X*X*X ) ,0 ,1 )\n                                                                                               (A)______(B)\nX axis = light distance to pixel                                                               \\\nY axis = light strength                                                           Y^             \\ (C)\n                                                                                                   X>\n\n--------------------------------------------------------------------------------\nLight Strength Falloff A [017]\n>= 1 is OFF\n      0 is ON\n  < 0 increases the 100% strength radius from inner to out, also results in a harder falloff for B and C.\n--------------------------------------------------------------------------------\nLight Soft Falloff B [018]\n<= 0 no Falloff\n--------------------------------------------------------------------------------\nLight Hard Falloff C [019]  -  Shall never go below 0\n--------------------------------------------------------------------------------"
		},
		{
			"eventType": "comment",
			"text": "Initializing variables for automated resolution algorithm. No need to enter manually."
		},
		{
			"eventType": "variable",
			"name": "VPR",
			"type": "number",
			"initialValue": "0",
			"comment": "Viewport Right (X coordinate)",
			"isStatic": true,
			"isConstant": false,
			"sid": 481407124972419
		},
		{
			"eventType": "variable",
			"name": "VPB",
			"type": "number",
			"initialValue": "0",
			"comment": "Viewport Bottom (Y coordinate)",
			"isStatic": true,
			"isConstant": false,
			"sid": 287276473001883
		},
		{
			"eventType": "variable",
			"name": "PR",
			"type": "number",
			"initialValue": "0",
			"comment": "Device Pixel Ratio",
			"isStatic": true,
			"isConstant": false,
			"sid": 368860786706967
		},
		{
			"eventType": "variable",
			"name": "WH",
			"type": "number",
			"initialValue": "0",
			"comment": "Height of canvas absolute size (including pixel ratio)",
			"isStatic": true,
			"isConstant": false,
			"sid": 773059037547027
		},
		{
			"eventType": "variable",
			"name": "WW",
			"type": "number",
			"initialValue": "0",
			"comment": "Width of canvas absolute size (including pixel ratio)",
			"isStatic": true,
			"isConstant": false,
			"sid": 122669093239176
		},
		{
			"eventType": "variable",
			"name": "WWL",
			"type": "number",
			"initialValue": "0",
			"comment": "Width of canvas - Light",
			"isStatic": true,
			"isConstant": false,
			"sid": 260268730614673
		},
		{
			"eventType": "variable",
			"name": "WHL",
			"type": "number",
			"initialValue": "0",
			"comment": "Height of canvas - Light",
			"isStatic": true,
			"isConstant": false,
			"sid": 109353941550532
		},
		{
			"eventType": "comment",
			"text": "Do not edit the offset unless you know what you're doing."
		},
		{
			"eventType": "variable",
			"name": "normalOffset",
			"type": "number",
			"initialValue": "16",
			"comment": "NormalMap32 - Parameter offset for next light",
			"isStatic": true,
			"isConstant": true,
			"sid": 618795988924036
		},
		{
			"eventType": "comment",
			"text": "Define how many Light IDs are effectively used in your layout. Keep as low as possible for best performance."
		},
		{
			"eventType": "variable",
			"name": "maxLightID",
			"type": "number",
			"initialValue": "4",
			"comment": "Max light ID used on runtime",
			"isStatic": true,
			"isConstant": false,
			"sid": 237218561971702
		},
		{
			"eventType": "group",
			"disabled": false,
			"title": "Max Light ID",
			"description": "",
			"isActiveOnStart": true,
			"children": [
				{
					"eventType": "comment",
					"text": "To keep shader iterations in the WebGL2 variant as minimal as possible, giving minor performance improvements if not utilizing all 32 lights.\nKeep in mind that this effect parameter will disable all Light IDs higher than the number defined."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "on-created",
							"objectClass": "fNormal",
							"sid": 103264632360207
						}
					],
					"actions": [
						{
							"type": "comment",
							"text": "Max Light ID [003]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 235119774575881,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "3",
								"value": "maxLightID"
							}
						}
					],
					"sid": 181579788030054
				}
			],
			"sid": 783338556091103
		},
		{
			"eventType": "group",
			"disabled": false,
			"title": "Screen Resolution",
			"description": "",
			"isActiveOnStart": true,
			"children": [
				{
					"eventType": "comment",
					"text": "Initialize viewport effect parameters for the normal map."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "on-start-of-layout",
							"objectClass": "System",
							"sid": 991379418971942
						}
					],
					"actions": [
						{
							"id": "wait",
							"objectClass": "System",
							"sid": 275710041639481,
							"parameters": {
								"seconds": "0"
							}
						},
						{
							"callFunction": "UpdateViewport",
							"sid": 655103553710295
						}
					],
					"sid": 930216670757962
				},
				{
					"eventType": "comment",
					"text": "Initialize viewport effect parameters upon normal map creation."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "on-created",
							"objectClass": "fNormal",
							"sid": 555088936004954
						}
					],
					"actions": [
						{
							"callFunction": "UpdateNormalViewport",
							"sid": 498199104280478,
							"parameters": [
								"fNormal.UID"
							]
						}
					],
					"sid": 595763658972727
				},
				{
					"eventType": "comment",
					"text": "Update viewport on the normal map effect parameters when viewport is being resized."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "on-resized",
							"objectClass": "Browser",
							"sid": 769791133612812
						}
					],
					"actions": [
						{
							"callFunction": "UpdateViewport",
							"sid": 204734784618070
						}
					],
					"sid": 220697385882607
				}
			],
			"sid": 134146154691551
		},
		{
			"eventType": "group",
			"disabled": false,
			"title": "Ambient Light",
			"description": "",
			"isActiveOnStart": true,
			"children": [
				{
					"eventType": "comment",
					"text": "In this example, we use Light ID 1 for a global ambient light source without a position."
				},
				{
					"eventType": "comment",
					"text": "Example Notice:\nThis specific code is redundant, because these effect parameters were already defined on the sprite effects itself. So make sure to take a closer look at the normal map sprite effect parameters to fully understand the light setup. Feel free to change the color or luminosity here for testing."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "on-created",
							"objectClass": "fNormal",
							"sid": 612221497989670
						}
					],
					"actions": [
						{
							"type": "comment",
							"text": "Light 1 Ambient (Red) [012]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 388336067195252,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "12",
								"value": "0.5"
							}
						},
						{
							"type": "comment",
							"text": "Light 1 Ambient (Green) [013]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 808913635007156,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "13",
								"value": "0.5"
							}
						},
						{
							"type": "comment",
							"text": "Light 1 Ambient (Blue) [014]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 201649436089123,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "14",
								"value": "0.5"
							}
						},
						{
							"type": "comment",
							"text": "Light 1 Ambient Luminosity [015]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 552262300881099,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "15",
								"value": "0.5"
							}
						}
					],
					"sid": 869879867923795
				}
			],
			"sid": 153188899670627
		},
		{
			"eventType": "group",
			"disabled": false,
			"title": "Light Bulp Positions",
			"description": "",
			"isActiveOnStart": true,
			"children": [
				{
					"eventType": "comment",
					"text": "Update light source positions on the normal map effect parameters every tick."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "for-each",
							"objectClass": "System",
							"sid": 282762614781409,
							"parameters": {
								"object": "fNormal"
							}
						},
						{
							"id": "for",
							"objectClass": "System",
							"sid": 160664195760070,
							"parameters": {
								"name": "\"\"",
								"start-index": "1",
								"end-index": "maxLightID-1"
							}
						},
						{
							"id": "compare-animation-frame",
							"objectClass": "LightSource",
							"sid": 268220330942560,
							"parameters": {
								"comparison": 0,
								"number": "loopindex"
							}
						},
						{
							"id": "pick-nearestfurthest",
							"objectClass": "LightSource",
							"sid": 756631800474053,
							"parameters": {
								"which": "nearest",
								"x": "fNormal.X",
								"y": "fNormal.Y"
							}
						}
					],
					"actions": [
						{
							"type": "comment",
							"text": "We loop through all light IDs on the layout, ambient light excluded. (#02 to #04)\nLess light source IDs used = better performance."
						},
						{
							"type": "comment",
							"text": "Only one light source of the same ID can interrogate with each normal map at a time.\nSo there should never be multiple lights of the same ID in close proximity to each other. (for example Light 2 and another Light 2)\nWe then always take the closest bulp of each ID to be considered as current active light, which allows us to place multiple instances of the same ID within the game world.\n\nThis allows us to use thousands of lights per layout, as we switch between them dynamically. Just space them far enough apart.\n\nImportant: Use as few light IDs as possible for maximum performance. Using all 32, although possible, will be very CPU and GPU hungry.\nFor example: world designed with only light ID 1-3 (each 10 times) will be much more performant than using type 1-30 (just one each), even if they're all out of view."
						},
						{
							"type": "comment",
							"text": "Update light position according to current viewport position in relation to the light"
						},
						{
							"type": "comment",
							"text": "Light 2-4 X Position [021]-[XXX]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 164397485240533,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "21-normalOffset+loopindex*normalOffset",
								"value": "(LayerToCanvasX(1, LightSource.X, 0))/(WWL)"
							}
						},
						{
							"type": "comment",
							"text": "Light 2-4 Y Position [022]-[XXX]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 577430067136965,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "22-normalOffset+loopindex *normalOffset",
								"value": "(LayerToCanvasY(1, 0, LightSource.Y))/(WHL)"
							}
						}
					],
					"sid": 724873553930363
				}
			],
			"sid": 792663045386308
		},
		{
			"eventType": "group",
			"disabled": false,
			"title": "Rotating Normal Map",
			"description": "",
			"isActiveOnStart": true,
			"children": [
				{
					"eventType": "comment",
					"text": "NormalMap32 supports rotated normal maps.\nSo for each normal map sprite with an angle other than 0, the effect requires the current sprite angle to display the light position accurately.\nSince ours is rotating continuously, we update the parameter on every tick.\nIf the Normal Map Angle parameter is set to 0, the shader will skip the rotating algorithm for improved performance."
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "pick-by-comparison",
							"objectClass": "System",
							"sid": 831929975184780,
							"parameters": {
								"object": "fNormal",
								"expression": "fNormal.Angle",
								"comparison": 1,
								"value": "0"
							}
						}
					],
					"actions": [
						{
							"type": "comment",
							"text": "Normal Map Angle [002]"
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 343116486957367,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "2",
								"value": "fNormal.Angle"
							}
						}
					],
					"sid": 943218580731394
				}
			],
			"sid": 275218210293953
		},
		{
			"eventType": "comment",
			"text": "Viewport Functions"
		},
		{
			"functionName": "UpdateViewport",
			"functionDescription": "Updates all Viewport related variables and updates all Normal Map Screen Resolution effect parameters accordingly.",
			"functionCategory": "Viewport",
			"functionReturnType": "none",
			"functionCopyPicked": false,
			"functionIsAsync": false,
			"functionParameters": [],
			"eventType": "function-block",
			"conditions": [],
			"actions": [],
			"sid": 840447208380024,
			"children": [
				{
					"eventType": "comment",
					"text": "Needed when viewport size or device pixelratio is changed, to render normal map lights positioned properly."
				},
				{
					"eventType": "block",
					"conditions": [],
					"actions": [
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 860590221900321,
							"parameters": {
								"variable": "PR",
								"value": "PlatformInfo.DevicePixelRatio\n"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 993147776039507,
							"parameters": {
								"variable": "VPB",
								"value": "ViewportBottom(1)"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 203526733729274,
							"parameters": {
								"variable": "VPR",
								"value": "ViewportRight(1)\n"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 505289495256606,
							"parameters": {
								"variable": "WWL",
								"value": "round(LayerToCanvasX(1,VPR,0))"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 290498144914092,
							"parameters": {
								"variable": "WHL",
								"value": "round(LayerToCanvasY(1,0,VPB))"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 547916882315523,
							"parameters": {
								"variable": "WW",
								"value": "round(LayerToCanvasX(1,VPR,0)*PR)"
							}
						},
						{
							"id": "set-eventvar-value",
							"objectClass": "System",
							"sid": 838155873041424,
							"parameters": {
								"variable": "WH",
								"value": "round(LayerToCanvasY(1,0,VPB)*PR)\n"
							}
						},
						{
							"callFunction": "UpdateNormalViewport",
							"sid": 956173220261987,
							"parameters": [
								"-1"
							]
						}
					],
					"sid": 709891875238117
				}
			]
		},
		{
			"functionName": "UpdateNormalViewport",
			"functionDescription": "Updates a Normal Maps' Screen X and Y Resolution effect parameters.",
			"functionCategory": "Viewport",
			"functionReturnType": "none",
			"functionCopyPicked": false,
			"functionIsAsync": false,
			"functionParameters": [
				{
					"name": "UIDnormal",
					"type": "number",
					"initialValue": "-1",
					"comment": "Normal Map UID, use (-1) to update all.",
					"sid": 241917405968939
				}
			],
			"eventType": "function-block",
			"conditions": [],
			"actions": [],
			"sid": 179327019392846,
			"children": [
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "compare-two-values",
							"objectClass": "System",
							"sid": 222873670692789,
							"parameters": {
								"first-value": "UIDnormal",
								"comparison": 1,
								"second-value": "-1"
							}
						},
						{
							"id": "pick-by-unique-id",
							"objectClass": "fNormal",
							"sid": 379190405132211,
							"parameters": {
								"unique-id": "UIDnormal"
							}
						}
					],
					"actions": [
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 671672679282056,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "0",
								"value": "WW"
							}
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 238526560571725,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "1",
								"value": "WH"
							}
						}
					],
					"sid": 411010232517125
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "else",
							"objectClass": "System",
							"sid": 233540283737280
						}
					],
					"actions": [
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 257698691879102,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "0",
								"value": "WW"
							}
						},
						{
							"id": "set-effect-parameter",
							"objectClass": "fNormal",
							"sid": 602212517966692,
							"parameters": {
								"effect": "\"NormalMap32\"",
								"parameter-index": "1",
								"value": "WH"
							}
						}
					],
					"sid": 302860329065571
				}
			]
		}
	],
	"sid": 562980631431129
}